-- ============================================
-- NVR设备监控系统 - 数据库初始化脚本
-- 数据库类型: 达梦数据库 (DM8+)
-- ============================================

-- 注意: 执行本脚本前，请确保已连接到 NVR_MONITOR 数据库
-- 在DM控制台执行以下命令切换模式:
-- SET SCHEMA SYSDBA;
-- 或者在DM管理工具中打开NVR_MONITOR数据库后直接执行脚本

-- ============================================
-- 1. 分公司表 (SYS_COMPANY)
-- ============================================
CREATE TABLE IF NOT EXISTS SYS_COMPANY (
    ID VARCHAR(36) PRIMARY KEY,
    NAME VARCHAR(100) NOT NULL,
    CODE VARCHAR(50) UNIQUE NOT NULL,
    PARENT_ID VARCHAR(36),
    ADDRESS VARCHAR(500),
    CONTACT_PERSON VARCHAR(50),
    CONTACT_PHONE VARCHAR(20),
    STATUS VARCHAR(10) DEFAULT '1',
    REMARKS VARCHAR(500),
    CREATE_TIME DATETIME DEFAULT SYSDATE,
    UPDATE_TIME DATETIME DEFAULT SYSDATE
);

-- ============================================
-- 2. 用户表 (SYS_USER)
-- ============================================
CREATE TABLE IF NOT EXISTS SYS_USER (
    ID VARCHAR(36) PRIMARY KEY,
    USERNAME VARCHAR(50) UNIQUE NOT NULL,
    PASSWORD VARCHAR(255) NOT NULL,
    REAL_NAME VARCHAR(50),
    PHONE VARCHAR(20),
    EMAIL VARCHAR(100),
    ROLE VARCHAR(20) DEFAULT 'USER',
    COMPANY_ID VARCHAR(36),
    STATUS VARCHAR(10) DEFAULT '1',
    LAST_LOGIN_TIME DATETIME,
    CREATE_TIME DATETIME DEFAULT SYSDATE,
    UPDATE_TIME DATETIME DEFAULT SYSDATE
);

-- ============================================
-- 3. NVR设备表 (NVR_DEVICE)
-- ============================================
CREATE TABLE IF NOT EXISTS NVR_DEVICE (
    ID VARCHAR(36) PRIMARY KEY,
    NAME VARCHAR(100) NOT NULL,
    CODE VARCHAR(50) UNIQUE NOT NULL,
    BRAND VARCHAR(20) NOT NULL,
    DEVICE_MODEL VARCHAR(100),
    IP_ADDRESS VARCHAR(50) NOT NULL,
    PORT INT DEFAULT 8000,
    USERNAME VARCHAR(50),
    PASSWORD VARCHAR(255),
    COMPANY_ID VARCHAR(36) NOT NULL,
    CHANNEL_COUNT INT DEFAULT 0,
    STATUS VARCHAR(20) DEFAULT 'ACTIVE',
    IS_ONLINE INT DEFAULT 0,
    LAST_ONLINE_TIME DATETIME,
    LAST_OFFLINE_TIME DATETIME,
    DEVICE_INFO TEXT,
    DISK_USAGE_RATE DECIMAL(5,2),
    REMARKS VARCHAR(500),
    CREATE_TIME DATETIME DEFAULT SYSDATE,
    UPDATE_TIME DATETIME DEFAULT SYSDATE
);

-- ============================================
-- 4. 设备状态记录表 (NVR_DEVICE_STATUS)
-- ============================================
CREATE TABLE IF NOT EXISTS NVR_DEVICE_STATUS (
    ID VARCHAR(36) PRIMARY KEY,
    DEVICE_ID VARCHAR(36) NOT NULL,
    CPU_USAGE DECIMAL(5,2),
    MEMORY_USAGE DECIMAL(5,2),
    DISK_TOTAL DECIMAL(10,2),
    DISK_USED DECIMAL(10,2),
    DISK_FREE DECIMAL(10,2),
    DISK_USAGE_RATE DECIMAL(5,2),
    DEVICE_TEMPERATURE DECIMAL(5,2),
    RECORDING_STATUS VARCHAR(20),
    CHANNEL_ONLINE_COUNT INT,
    CHANNEL_TOTAL_COUNT INT,
    NETWORK_STATUS VARCHAR(20),
    SYSTEM_TIME DATETIME,
    RAW_DATA TEXT,
    CREATE_TIME DATETIME DEFAULT SYSDATE
);

-- ============================================
-- 5. 告警表 (NVR_ALARM)
-- ============================================
CREATE TABLE IF NOT EXISTS NVR_ALARM (
    ID VARCHAR(36) PRIMARY KEY,
    DEVICE_ID VARCHAR(36) NOT NULL,
    ALARM_TYPE VARCHAR(50) NOT NULL,
    ALARM_LEVEL VARCHAR(20) NOT NULL,
    ALARM_TITLE VARCHAR(200) NOT NULL,
    ALARM_CONTENT TEXT,
    ALARM_VALUE VARCHAR(100),
    STATUS VARCHAR(20) DEFAULT 'PENDING',
    HANDLER_ID VARCHAR(36),
    HANDLE_TIME DATETIME,
    HANDLE_CONTENT VARCHAR(500),
    CREATE_TIME DATETIME DEFAULT SYSDATE
);

-- ============================================
-- 6. 系统配置表 (SYS_CONFIG)
-- ============================================
CREATE TABLE IF NOT EXISTS SYS_CONFIG (
    ID VARCHAR(36) PRIMARY KEY,
    CONFIG_KEY VARCHAR(100) UNIQUE NOT NULL,
    CONFIG_VALUE TEXT,
    CONFIG_TYPE VARCHAR(50),
    DESCRIPTION VARCHAR(200),
    STATUS VARCHAR(10) DEFAULT '1',
    CREATE_TIME DATETIME DEFAULT SYSDATE,
    UPDATE_TIME DATETIME DEFAULT SYSDATE
);

-- ============================================
-- 7. 操作日志表 (SYS_OPER_LOG)
-- ============================================
CREATE TABLE IF NOT EXISTS SYS_OPER_LOG (
    ID VARCHAR(36) PRIMARY KEY,
    USER_ID VARCHAR(36),
    OPER_TYPE VARCHAR(50),
    OPER_CONTENT TEXT,
    OPER_IP VARCHAR(50),
    CREATE_TIME DATETIME DEFAULT SYSDATE
);

-- ============================================
-- 创建索引
-- ============================================
CREATE INDEX IDX_DEVICE_STATUS_DEVICE_ID ON NVR_DEVICE_STATUS(DEVICE_ID);
CREATE INDEX IDX_DEVICE_STATUS_TIME ON NVR_DEVICE_STATUS(CREATE_TIME);
CREATE INDEX IDX_ALARM_DEVICE_ID ON NVR_ALARM(DEVICE_ID);
CREATE INDEX IDX_ALARM_STATUS ON NVR_ALARM(STATUS);
CREATE INDEX IDX_ALARM_CREATE_TIME ON NVR_ALARM(CREATE_TIME);
CREATE INDEX IDX_OPER_LOG_USER ON SYS_OPER_LOG(USER_ID);
CREATE INDEX IDX_OPER_LOG_TIME ON SYS_OPER_LOG(CREATE_TIME);

-- ============================================
-- 初始化数据
-- ============================================

-- 1. 初始化总公司
INSERT INTO SYS_COMPANY (ID, NAME, CODE, STATUS)
VALUES ('11000000000000000000000000000000', '集团总部', 'GROUP', '1');

-- 2. 初始化管理员账号 (密码: admin123)
-- 密码经过BCRYPT加密
INSERT INTO SYS_USER (ID, USERNAME, PASSWORD, REAL_NAME, ROLE, COMPANY_ID, STATUS)
VALUES (
    '550e8400-e29b-41d4-a716-446655440000',
    'admin',
    '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZRGdjGj/nMskyB.8a5NW2x.nx8RC',
    '系统管理员',
    'ADMIN',
    '11000000000000000000000000000000',
    '1'
);

-- 3. 初始化系统配置
INSERT INTO SYS_CONFIG (ID, CONFIG_KEY, CONFIG_VALUE, CONFIG_TYPE, DESCRIPTION)
VALUES 
    ('config-001', 'DATA_COLLECTION_INTERVAL', '30000', 'SYSTEM', '数据采集间隔(毫秒)'),
    ('config-002', 'ALARM_CHECK_INTERVAL', '10000', 'SYSTEM', '告警检测间隔(毫秒)'),
    ('config-003', 'DISK_FULL_THRESHOLD', '90', 'ALARM', '硬盘满告警阈值(%)'),
    ('config-004', 'DISK_WARNING_THRESHOLD', '80', 'ALARM', '硬盘预警阈值(%)'),
    ('config-005', 'DEVICE_OFFLINE_TIMEOUT', '120', 'SYSTEM', '设备离线判定时间(秒)');

-- 4. 创建示例分公司
INSERT INTO SYS_COMPANY (ID, NAME, CODE, PARENT_ID, ADDRESS, CONTACT_PERSON, CONTACT_PHONE, STATUS)
VALUES 
    ('11010000000000000000000000000001', '北京分公司', 'BEIJING', '11000000000000000000000000000000', '北京市海淀区', '张经理', '010-12345678', '1'),
    ('11010000000000000000000000000002', '上海分公司', 'SHANGHAI', '11000000000000000000000000000000', '上海市浦东新区', '李经理', '021-87654321', '1'),
    ('11010000000000000000000000000003', '广州分公司', 'GUANGZHOU', '11000000000000000000000000000000', '广州市天河区', '王经理', '020-11223344', '1');

-- 5. 创建示例用户
INSERT INTO SYS_USER (ID, USERNAME, PASSWORD, REAL_NAME, ROLE, COMPANY_ID, STATUS)
VALUES 
    ('660e8400-e29b-41d4-a716-446655440001', 'operator1', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZRGdjGj/nMskyB.8a5NW2x.nx8RC', '操作员1', 'USER', '11010000000000000000000000000001', '1'),
    ('660e8400-e29b-41d4-a716-446655440002', 'operator2', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZRGdjGj/nMskyB.8a5NW2x.nx8RC', '操作员2', 'USER', '11010000000000000000000000000002', '1');

-- 6. 创建示例设备
INSERT INTO NVR_DEVICE (ID, NAME, CODE, BRAND, DEVICE_MODEL, IP_ADDRESS, PORT, USERNAME, PASSWORD, COMPANY_ID, CHANNEL_COUNT, STATUS)
VALUES 
    ('770e8400-e29b-41d4-a716-446655440001', '北京NVR-01', 'NVR-BJ-001', 'HIKVISION', 'DS-7600系列', '192.168.1.100', 8000, 'admin', 'YWRtaW4=', '11010000000000000000000000000001', 16, 'ACTIVE'),
    ('770e8400-e29b-41d4-a716-446655440002', '北京NVR-02', 'NVR-BJ-002', 'DAHUA', 'DH-NVR系列', '192.168.1.101', 8000, 'admin', 'YWRtaW4=', '11010000000000000000000000000001', 8, 'ACTIVE'),
    ('770e8400-e29b-41d4-a716-446655440003', '上海NVR-01', 'NVR-SH-001', 'HIKVISION', 'DS-7600系列', '192.168.2.100', 8000, 'admin', 'YWRtaW4=', '11010000000000000000000000000002', 16, 'ACTIVE'),
    ('770e8400-e29b-41d4-a716-446655440004', '广州NVR-01', 'NVR-GZ-001', 'DAHUA', 'DH-NVR系列', '192.168.3.100', 8000, 'admin', 'YWRtaW4=', '11010000000000000000000000000003', 8, 'ACTIVE');

-- ============================================
-- 数据验证
-- ============================================
SELECT '分公司数量: ' || CAST(COUNT(*) AS VARCHAR) AS COUNT_INFO FROM SYS_COMPANY;
SELECT '用户数量: ' || CAST(COUNT(*) AS VARCHAR) AS COUNT_INFO FROM SYS_USER;
SELECT '设备数量: ' || CAST(COUNT(*) AS VARCHAR) AS COUNT_INFO FROM NVR_DEVICE;
SELECT '配置项数量: ' || CAST(COUNT(*) AS VARCHAR) AS COUNT_INFO FROM SYS_CONFIG;

SELECT '初始化完成！' AS MESSAGE FROM DUAL;
