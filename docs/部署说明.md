# NVR设备监控系统 - 部署说明

## 1. 系统概述

NVR设备监控系统是一个用于实时监控集团公司视频监控NVR存储设备的Web系统，支持海康威视和大华两大品牌的NVR设备集成。

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      前端 (Vue2 + ElementUI)                 │
│                      运行端口: 8080                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     后端 (Node.js + Express)                 │
│                     运行端口: 3000                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  数据采集服务 │  │  Socket.IO  │  │  JWT认证服务        │  │
│  │  (定时任务)   │  │  (实时推送)  │  │  (权限管理)        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    达梦数据库 (DM8+)                          │
│                    端口: 5236                                │
└─────────────────────────────────────────────────────────────┘
```

## 3. 环境要求

### 3.1 硬件要求

| 项目 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核及以上 |
| 内存 | 4GB | 8GB及以上 |
| 硬盘 | 100GB | 500GB及以上 |
| 网络 | 100Mbps | 1Gbps |

### 3.2 软件要求

| 软件 | 版本要求 |
|------|----------|
| Node.js | 16.x 或 18.x |
| npm | 8.x 及以上 |
| 达梦数据库 | DM8 及以上 |
| 操作系统 | Windows Server / Linux |

## 4. 部署步骤

### 4.1 数据库部署

1. **安装达梦数据库**

   下载并安装达梦数据库DM8，安装过程中选择默认配置。

2. **创建数据库和表空间**

   ```sql
   -- 创建数据库
   CREATE DATABASE NVR_MONITOR FILE '/dm8/data/NVR_MONITOR/dm.nvr_monitor.dbf' SIZE 500;
   ```

3. **执行初始化脚本**

   ```bash
   # 连接到数据库
   dis SYSDBA/SYSDBA@localhost:5236
   
   # 执行初始化SQL脚本
   SQL> start init_database.sql
   ```

4. **创建数据库用户**

   ```sql
   CREATE USER NVR_MONITOR IDENTIFIED BY "YourPassword123";
   GRANT DBA TO NVR_MONITOR;
   ```

### 4.2 后端服务部署

1. **上传代码**

   ```bash
   # 解压项目代码
   unzip nvr-monitor-backend.zip
   cd nvr-monitor-backend
   ```

2. **安装依赖**

   ```bash
   npm install --production
   ```

3. **配置环境变量**

   ```bash
   # 复制环境配置文件
   cp .env.example .env
   
   # 编辑配置文件
   vi .env
   ```

   主要配置项：
   ```env
   # 数据库配置
   DB_HOST=localhost
   DB_PORT=5236
   DB_USER=your_db_user
   DB_PASSWORD=your_db_password
   DB_NAME=NVR_MONITOR
   
   # JWT密钥
   JWT_SECRET=your-jwt-secret-key
   
   # 服务器端口
   PORT=3000
   
   # 前端地址
   FRONTEND_URL=http://your-frontend-ip:8080
   ```

4. **启动服务**

   ```bash
   # 生产环境启动
   npm start
   
   # 或使用PM2管理进程
   npm install -g pm2
   pm2 start app.js --name nvr-monitor-backend
   ```

5. **验证服务**

   ```bash
   # 检查服务状态
   curl http://localhost:3000/api/health
   
   # 预期输出: {"status":"ok","timestamp":"...","uptime":...}
   ```

### 4.3 前端服务部署

1. **上传代码**

   ```bash
   unzip nvr-monitor-frontend.zip
   cd nvr-monitor-frontend
   ```

2. **安装依赖**

   ```bash
   npm install
   ```

3. **构建生产版本**

   ```bash
   npm run build
   ```

4. **配置Nginx**

   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       
       # 前端静态文件
       location / {
           root /var/www/nvr-monitor/dist;
           index index.html;
           try_files $uri $uri/ /index.html;
       }
       
       # API代理
       location /api {
           proxy_pass http://localhost:3000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
       
       # WebSocket代理
       location /socket.io {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
       }
   }
   ```

5. **重启Nginx**

   ```bash
   nginx -t
   nginx -s reload
   ```

## 5. 系统配置

### 5.1 设备接入配置

在系统中添加NVR设备时，需要提供以下信息：

| 配置项 | 说明 |
|--------|------|
| 设备名称 | 自定义名称 |
| 设备编码 | 唯一标识 |
| 设备品牌 | 海康威视/大华 |
| IP地址 | 设备IP地址 |
| 端口号 | 默认: 8000 |
| 用户名 | 设备管理用户名 |
| 密码 | 设备管理密码 |
| 所属公司 | 选择所属分公司 |

### 5.2 告警规则配置

系统内置以下告警规则：

| 告警类型 | 触发条件 | 告警级别 |
|----------|----------|----------|
| 硬盘空间严重不足 | 使用率 >= 90% | 高危 |
| 硬盘空间预警 | 使用率 >= 80% | 中危 |
| 设备离线 | 设备离线 | 高危 |
| 设备上线 | 设备恢复在线 | 信息 |
| 网络不稳定 | 网络状态异常 | 中危 |

### 5.3 数据采集配置

```javascript
// 在后端 .env 文件中配置
DATA_COLLECTION_INTERVAL=30000    // 数据采集间隔(毫秒), 默认30秒
ALARM_CHECK_INTERVAL=10000        // 告警检测间隔(毫秒), 默认10秒
```

## 6. 运维管理

### 6.1 日志管理

日志文件位于 `backend/logs/` 目录：

| 日志文件 | 说明 |
|----------|------|
| error.log | 错误日志 |
| combined.log | 综合日志 |

### 6.2 进程管理

使用PM2管理进程：

```bash
# 查看进程状态
pm2 list

# 查看日志
pm2 logs nvr-monitor-backend

# 重启服务
pm2 restart nvr-monitor-backend

# 停止服务
pm2 stop nvr-monitor-backend
```

### 6.3 数据备份

```bash
# 定时备份数据库
0 2 * * * /dm8/bin/dexp SYSDBA/SYSDBA@localhost:5236 FILE=/backup/nvr_$(date +%Y%m%d).dmp LOG=/backup/nvr_$(date +%Y%m%d).log FULL=Y
```

### 6.4 健康检查

```bash
# 检查服务健康状态
curl http://localhost:3000/api/health

# 检查数据库连接
mysql -h localhost -P 5236 -u user -p -e "SELECT 1"
```

## 7. 常见问题

### Q1: 设备连接测试失败
- 检查设备IP地址和端口是否正确
- 检查设备用户名和密码是否正确
- 检查设备是否支持API访问
- 检查网络是否通畅

### Q2: 数据采集不及时
- 检查数据采集间隔配置
- 检查设备API响应速度
- 检查服务器性能

### Q3: 告警没有实时推送
- 检查WebSocket连接状态
- 检查浏览器控制台是否有错误
- 检查Nginx是否支持WebSocket代理

### Q4: 登录失败
- 检查用户名和密码是否正确
- 检查用户状态是否启用
- 检查Token是否过期

## 8. 技术支持

如遇到问题，请联系技术支持团队：

- 邮箱: support@example.com
- 电话: 400-xxx-xxxx
