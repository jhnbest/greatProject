# NVR设备监控系统 - 数据库设计文档

## 1. 数据库概述

- **数据库类型**: 达梦数据库 (DM Database)
- **数据库版本**: DM8及以上
- **字符集**: UTF8
- **数据库名**: NVR_MONITOR

## 2. 表结构设计

### 2.1 分公司表 (SYS_COMPANY)

存储集团公司的分公司层级结构信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| ID | VARCHAR | 36 | 是 | - | 主键, UUID |
| NAME | VARCHAR | 100 | 是 | - | 公司名称 |
| CODE | VARCHAR | 50 | 是 | - | 公司编码, 唯一 |
| PARENT_ID | VARCHAR | 36 | 否 | NULL | 上级公司ID |
| ADDRESS | VARCHAR | 500 | 否 | NULL | 联系地址 |
| CONTACT_PERSON | VARCHAR | 50 | 否 | NULL | 联系人 |
| CONTACT_PHONE | VARCHAR | 20 | 否 | NULL | 联系电话 |
| STATUS | VARCHAR | 10 | 否 | '1' | 状态: 1-启用, 0-禁用 |
| REMARKS | VARCHAR | 500 | 否 | NULL | 备注 |
| CREATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| UPDATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `PK_SYS_COMPANY`: ID (主键)
- `UK_SYS_COMPANY_CODE`: CODE (唯一索引)
- `FK_SYS_COMPANY_PARENT`: PARENT_ID (外键)

### 2.2 用户表 (SYS_USER)

存储系统用户信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| ID | VARCHAR | 36 | 是 | - | 主键, UUID |
| USERNAME | VARCHAR | 50 | 是 | - | 用户名, 唯一 |
| PASSWORD | VARCHAR | 255 | 是 | - | 密码(加密) |
| REAL_NAME | VARCHAR | 50 | 否 | NULL | 真实姓名 |
| PHONE | VARCHAR | 20 | 否 | NULL | 手机号码 |
| EMAIL | VARCHAR | 100 | 否 | NULL | 电子邮箱 |
| ROLE | VARCHAR | 20 | 否 | 'USER' | 角色: ADMIN, USER, OPERATOR |
| COMPANY_ID | VARCHAR | 36 | 否 | NULL | 所属公司ID |
| STATUS | VARCHAR | 10 | 否 | '1' | 状态: 1-启用, 0-禁用 |
| LAST_LOGIN_TIME | DATETIME | - | 否 | NULL | 最后登录时间 |
| CREATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| UPDATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `PK_SYS_USER`: ID (主键)
- `UK_SYS_USER_USERNAME`: USERNAME (唯一索引)

### 2.3 NVR设备表 (NVR_DEVICE)

存储NVR设备的基本信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| ID | VARCHAR | 36 | 是 | - | 主键, UUID |
| NAME | VARCHAR | 100 | 是 | - | 设备名称 |
| CODE | VARCHAR | 50 | 是 | - | 设备编码, 唯一 |
| BRAND | VARCHAR | 20 | 是 | - | 品牌: HIKVISION, DAHUA |
| MODEL | VARCHAR | 100 | 否 | NULL | 设备型号 |
| IP_ADDRESS | VARCHAR | 50 | 是 | - | IP地址 |
| PORT | INT | - | 否 | 8000 | 端口号 |
| USERNAME | VARCHAR | 50 | 是 | - | 设备用户名 |
| PASSWORD | VARCHAR | 255 | 是 | - | 设备密码(加密) |
| COMPANY_ID | VARCHAR | 36 | 是 | - | 所属公司ID |
| CHANNEL_COUNT | INT | - | 否 | 0 | 通道数量 |
| STATUS | VARCHAR | 20 | 否 | 'ACTIVE' | 状态: ACTIVE, INACTIVE |
| IS_ONLINE | TINYINT | - | 否 | 0 | 是否在线: 0-离线, 1-在线 |
| LAST_ONLINE_TIME | DATETIME | - | 否 | NULL | 最后上线时间 |
| LAST_OFFLINE_TIME | DATETIME | - | 否 | NULL | 最后离线时间 |
| DEVICE_INFO | TEXT | - | 否 | NULL | 设备详细信息(JSON) |
| DISK_USAGE_RATE | DECIMAL | (5,2) | 否 | NULL | 硬盘使用率 |
| REMARKS | VARCHAR | 500 | 否 | NULL | 备注 |
| CREATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| UPDATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `PK_NVR_DEVICE`: ID (主键)
- `UK_NVR_DEVICE_CODE`: CODE (唯一索引)
- `FK_NVR_DEVICE_COMPANY`: COMPANY_ID (外键)

### 2.4 设备状态记录表 (NVR_DEVICE_STATUS)

存储设备的实时状态数据。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| ID | VARCHAR | 36 | 是 | - | 主键, UUID |
| DEVICE_ID | VARCHAR | 36 | 是 | - | 设备ID |
| CPU_USAGE | DECIMAL | (5,2) | 否 | NULL | CPU使用率 |
| MEMORY_USAGE | DECIMAL | (5,2) | 否 | NULL | 内存使用率 |
| DISK_TOTAL | DECIMAL | (10,2) | 否 | NULL | 硬盘总容量(GB) |
| DISK_USED | DECIMAL | (10,2) | 否 | NULL | 硬盘已用空间(GB) |
| DISK_FREE | DECIMAL | (10,2) | 否 | NULL | 硬盘剩余空间(GB) |
| DISK_USAGE_RATE | DECIMAL | (5,2) | 否 | NULL | 硬盘使用率 |
| DEVICE_TEMPERATURE | DECIMAL | (5,2) | 否 | NULL | 设备温度 |
| RECORDING_STATUS | VARCHAR | 20 | 否 | NULL | 录像状态 |
| CHANNEL_ONLINE_COUNT | INT | - | 否 | NULL | 在线通道数 |
| CHANNEL_TOTAL_COUNT | INT | - | 否 | NULL | 总通道数 |
| NETWORK_STATUS | VARCHAR | 20 | 否 | NULL | 网络状态 |
| SYSTEM_TIME | DATETIME | - | 否 | NULL | 设备系统时间 |
| RAW_DATA | TEXT | - | 否 | NULL | 原始数据(JSON) |
| CREATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 记录时间 |

**索引**:
- `PK_NVR_DEVICE_STATUS`: ID (主键)
- `IDX_DEVICE_STATUS_DEVICE_ID`: DEVICE_ID
- `IDX_DEVICE_STATUS_TIME`: CREATE_TIME

### 2.5 告警表 (NVR_ALARM)

存储设备告警信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| ID | VARCHAR | 36 | 是 | - | 主键, UUID |
| DEVICE_ID | VARCHAR | 36 | 是 | - | 设备ID |
| ALARM_TYPE | VARCHAR | 50 | 是 | - | 告警类型: DISK, DEVICE, NETWORK, CHANNEL |
| ALARM_LEVEL | VARCHAR | 20 | 是 | - | 告警级别: HIGH, MEDIUM, LOW, INFO |
| ALARM_TITLE | VARCHAR | 200 | 是 | - | 告警标题 |
| ALARM_CONTENT | TEXT | - | 否 | NULL | 告警内容 |
| ALARM_VALUE | VARCHAR | 100 | 否 | NULL | 告警值 |
| STATUS | VARCHAR | 20 | 否 | 'PENDING' | 状态: PENDING, HANDLED |
| HANDLER_ID | VARCHAR | 36 | 否 | NULL | 处理人ID |
| HANDLE_TIME | DATETIME | - | 否 | NULL | 处理时间 |
| HANDLE_CONTENT | VARCHAR | 500 | 否 | NULL | 处理意见 |
| CREATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 告警时间 |

**索引**:
- `PK_NVR_ALARM`: ID (主键)
- `IDX_ALARM_DEVICE_ID`: DEVICE_ID
- `IDX_ALARM_CREATE_TIME`: CREATE_TIME
- `IDX_ALARM_STATUS`: STATUS

### 2.6 系统配置表 (SYS_CONFIG)

存储系统配置信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| ID | VARCHAR | 36 | 是 | - | 主键, UUID |
| CONFIG_KEY | VARCHAR | 100 | 是 | - | 配置键, 唯一 |
| CONFIG_VALUE | TEXT | - | 否 | NULL | 配置值 |
| CONFIG_TYPE | VARCHAR | 50 | 否 | NULL | 配置类型 |
| DESCRIPTION | VARCHAR | 200 | 否 | NULL | 配置描述 |
| STATUS | VARCHAR | 10 | 否 | '1' | 状态: 1-启用, 0-禁用 |
| CREATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| UPDATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `PK_SYS_CONFIG`: ID (主键)
- `UK_SYS_CONFIG_KEY`: CONFIG_KEY (唯一索引)

### 2.7 操作日志表 (SYS_OPER_LOG)

存储用户操作日志。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| ID | VARCHAR | 36 | 是 | - | 主键, UUID |
| USER_ID | VARCHAR | 36 | 否 | NULL | 用户ID |
| OPER_TYPE | VARCHAR | 50 | 否 | NULL | 操作类型 |
| OPER_CONTENT | TEXT | - | 否 | NULL | 操作内容 |
| OPER_IP | VARCHAR | 50 | 否 | NULL | 操作IP |
| CREATE_TIME | DATETIME | - | 否 | CURRENT_TIMESTAMP | 操作时间 |

**索引**:
- `PK_SYS_OPER_LOG`: ID (主键)
- `IDX_OPER_LOG_USER`: USER_ID
- `IDX_OPER_LOG_TIME`: CREATE_TIME

## 3. ER关系图

```
SYS_COMPANY (分公司)
  ├── 1:N ─── NVR_DEVICE (设备)
  │           └── 1:N ─── NVR_DEVICE_STATUS (状态记录)
  │           └── 1:N ─── NVR_ALARM (告警)
  └── 1:N ─── SYS_USER (用户)

SYS_USER (用户)
  └── 1:N ─── NVR_ALARM (处理记录)
```

## 4. 数据初始化

### 4.1 初始化管理员账号

```sql
-- 管理员账号: admin / admin123
INSERT INTO SYS_USER (ID, USERNAME, PASSWORD, REAL_NAME, ROLE, COMPANY_ID, STATUS)
VALUES ('550e8400-e29b-41d4-a716-446655440000', 'admin', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZRGdjGj/nMskyB.8a5NW2x.nx8RC', '系统管理员', 'ADMIN', NULL, '1');
```

### 4.2 初始化总公司

```sql
INSERT INTO SYS_COMPANY (ID, NAME, CODE, STATUS)
VALUES ('11000000000000000000000000000000', '集团总部', 'GROUP', '1');
```

## 5. 数据维护

### 5.1 设备状态数据清理策略

建议每天凌晨2点执行数据清理任务，保留最近30天的状态数据：

```sql
DELETE FROM NVR_DEVICE_STATUS 
WHERE CREATE_TIME < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 5.2 告警数据清理策略

建议每月执行一次告警数据归档，保留最近6个月的数据：

```sql
-- 归档到历史表
INSERT INTO NVR_ALARM_HISTORY 
SELECT * FROM NVR_ALARM 
WHERE CREATE_TIME < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- 删除已归档数据
DELETE FROM NVR_ALARM 
WHERE CREATE_TIME < DATE_SUB(NOW(), INTERVAL 6 MONTH);
```
